<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Interactivo de Bonos de Vivienda - Costa Rica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 500px;
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .leaflet-popup-content {
            font-family: 'Montserrat', sans-serif;
        }
        .legend {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 450px;
            }
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .nav-link {
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        .nav-link:hover {
            color: #00487C;
        }
        .active-nav {
            color: #00487C;
            font-weight: 600;
            border-bottom: 2px solid #00487C;
        }
        .gemini-response {
            background-color: #f0f9ff;
            border-left: 4px solid #4BB3FD;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.25rem;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4BB3FD;
            animation: spin 1s ease infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">An√°lisis de Subsidios de Vivienda</h1>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#overview" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Vista General</a>
                        <a href="#profile" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Beneficiarios</a>
                        <a href="#geo" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Geograf√≠a</a>
                        <a href="#financial" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Financiero</a>
                        <a href="#assistant" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700">Asistente IA</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <section id="overview" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Vista General del Programa</h2>
            <p class="text-lg text-gray-600 mb-8">Un resumen de los hallazgos clave sobre los 6,226 subsidios de vivienda analizados.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="kpi-card">
                    <h3 class="text-gray-500 font-medium">Total de Casos</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">6,226</p>
                    <p class="text-sm text-gray-500 mt-2">Registros √∫nicos validados</p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-gray-500 font-medium">Monto Promedio del Bono</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">~‚Ç°21.17M</p>
                    <p class="text-sm text-gray-500 mt-2">Cubre casi el 100% de la soluci√≥n</p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-gray-500 font-medium">Soluci√≥n Promedio Pagada</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">~‚Ç°21.29M</p>
                    <p class="text-sm text-gray-500 mt-2">Costo promedio de la vivienda</p>
                </div>
                <div class="kpi-card">
                    <h3 class="text-gray-500 font-medium">Jefatura Femenina</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">75.5%</p>
                    <p class="text-sm text-gray-500 mt-2">De los subsidios son para hogares liderados por mujeres</p>
                </div>
            </div>
        </section>

        <hr class="my-12 border-gray-200">

        <section id="profile" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">¬øQui√©nes son los Beneficiarios?</h2>
            <p class="text-lg text-gray-600 mb-8">Perfil sociodemogr√°fico de las familias, demostrando la efectiva focalizaci√≥n del programa.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="kpi-card text-center">
                    <h3 class="text-gray-500 font-medium">Edad Promedio</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">40.6 a√±os</p>
                </div>
                <div class="kpi-card text-center">
                    <h3 class="text-gray-500 font-medium">Nacionales</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">90.8%</p>
                </div>
                <div class="kpi-card text-center">
                    <h3 class="text-gray-500 font-medium">Extranjeros</h3>
                    <p class="text-4xl font-bold text-[#00487C] mt-2">9.2%</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-center">Nivel Educativo por G√©nero</h3>
                     <p class="text-center text-gray-600 mb-4 max-w-3xl mx-auto">La mayor√≠a de beneficiarios tiene un nivel educativo de primaria o inferior, reforzando el enfoque del programa en poblaciones vulnerables.</p>
                    <div class="chart-container mx-auto">
                        <canvas id="educationGenderChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-center">Distribuci√≥n de Ingresos del N√∫cleo Familiar</h3>
                    <p class="text-center text-gray-600 mb-4 max-w-3xl mx-auto">El histograma muestra que la gran mayor√≠a de las familias beneficiarias tienen ingresos mensuales muy bajos, validando la focalizaci√≥n del programa.</p>
                    <div class="chart-container mx-auto">
                        <canvas id="incomeHistogramChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <hr class="my-12 border-gray-200">

        <section id="geo" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">An√°lisis Geogr√°fico y de Movilidad</h2>
            <p class="text-lg text-gray-600 mb-8">Explore la distribuci√≥n espacial de los subsidios. El mapa interactivo muestra la concentraci√≥n por provincia.</p>

            <div class="bg-white p-6 rounded-lg shadow border border-gray-200 mb-8">
                <h3 class="text-xl font-semibold mb-4 text-center">Mapa Interactivo de Casos por Provincia</h3>
                <div id="map"></div>
            </div>

            <div class="grid grid-cols-1 gap-8 items-start">
                 <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="text-xl font-semibold text-center">Principales Corredores de Movilidad Cantonal</h3>
                    <p class="text-sm text-gray-600 my-4 text-center">Esta tabla muestra los 10 flujos de reubicaci√≥n m√°s significativos entre cantones. Revela que el desarraigo ocurre principalmente hacia cantones cercanos o distritos espec√≠ficos.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 font-semibold">Cant√≥n de Origen</th>
                                    <th class="p-2 font-semibold">Cant√≥n/Distrito de Destino</th>
                                    <th class="p-2 font-semibold text-center">N¬∫ de Familias</th>
                                </tr>
                            </thead>
                            <tbody id="cantonFlowsTable" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <hr class="my-12 border-gray-200">

        <section id="financial" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">An√°lisis Financiero</h2>
            <p class="text-lg text-gray-600 mb-8">Detalles sobre el destino de la inversi√≥n y los programas de financiamiento.</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-center">Distribuci√≥n por Prop√≥sito del Bono</h3>
                     <div class="mb-4 flex justify-center">
                        <select id="provinceFilter" class="border-gray-300 rounded-md shadow-sm focus:border-sky-500 focus:ring-sky-500">
                            <option value="Todos">Todas las Provincias</option>
                            <option value="San Jos√©">San Jos√©</option>
                            <option value="Alajuela">Alajuela</option>
                            <option value="Cartago">Cartago</option>
                            <option value="Heredia">Heredia</option>
                            <option value="Guanacaste">Guanacaste</option>
                            <option value="Puntarenas">Puntarenas</option>
                            <option value="Lim√≥n">Lim√≥n</option>
                        </select>
                    </div>
                    <p class="text-center text-gray-600 mb-4">Filtre por provincia y haga clic en una secci√≥n para ver detalles.</p>
                    <div class="chart-container mx-auto">
                        <canvas id="purposeChart"></canvas>
                    </div>
                    <div id="purposeChartDetails" class="mt-4 text-center text-sm text-gray-600 bg-gray-50 p-3 rounded-lg" style="display: none;"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4 text-center">Distribuci√≥n por Programa de Financiamiento</h3>
                    <div class="chart-container mx-auto">
                        <canvas id="programChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <hr class="my-12 border-gray-200">

        <section id="assistant" class="scroll-mt-20">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Asistente de Pol√≠ticas P√∫blicas IA</h2>
            <p class="text-lg text-gray-600 mb-8">¬øTiene alguna pregunta sobre los datos? P√≠dale a nuestro asistente de IA que analice la informaci√≥n y le proporcione respuestas contextualizadas.</p>
            <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                <div class="w-full mb-6">
                    <label for="policyQuestion" class="block text-sm font-medium text-gray-700">Escriba su consulta</label>
                    <textarea id="policyQuestion" class="mt-1 w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="Ej: ¬øCu√°l es el principal desaf√≠o en Puntarenas?"></textarea>
                    <button id="askAssistantBtn" class="mt-4 w-full bg-[#00487C] text-white px-4 py-2 rounded-lg hover:bg-[#027BCE] transition-colors font-semibold">‚ú® Preguntar al Asistente</button>
                </div>
                 <div class="flex justify-center items-center">
                    <button id="generateAnalysisBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold">üìÑ Generar Resumen Ejecutivo y Recomendaciones</button>
                </div>
                <div id="assistantLoader" class="hidden"><div class="spinner"></div></div>
                <div id="assistantResult" class="gemini-response hidden"></div>
            </div>
        </section>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            const colors = {
                primary: '#00487C',
                secondary: '#4BB3FD',
                accent: '#0496FF',
                gray: '#9CA3AF',
                chartPalette: ['#00487C', '#4BB3FD', '#3E6680', '#0496FF', '#027BCE', '#F0F8FF']
            };

            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${new Intl.NumberFormat('es-CR').format(c.raw)}` } } },
                scales: { y: { beginAtZero: true, ticks: { callback: (v) => v >= 1e6 ? `${v/1e6}M` : (v >= 1e3 ? `${v/1e3}K` : v) } } }
            };
            const pieChartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => {
                    const total = c.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    const percentage = ((c.raw / total) * 100).toFixed(1) + '%';
                    return `${c.label}: ${new Intl.NumberFormat('es-CR').format(c.raw)} (${percentage})`;
                }}}}
            };

            const data = {
                educationByGender: {
                    labels: ['Primaria', 'Secundaria', 'Sin Estudios', 'Otros'],
                    datasets: [
                        { label: 'Femenino', data: [3142, 734, 734, 90], backgroundColor: colors.primary },
                        { label: 'Masculino', data: [1084, 232, 155, 37], backgroundColor: colors.secondary },
                        { label: 'Indefinido', data: [0, 0, 0, 18], backgroundColor: colors.gray }
                    ]
                },
                incomeDistribution: {
                    labels: ['0-150k', '150-300k', '300-450k', '450-600k', '>600k'],
                    values: [3000, 2500, 550, 100, 76]
                },
                provinces: { 'Puntarenas': 1457, 'Lim√≥n': 1213, 'Alajuela': 1126, 'Cartago': 775, 'Guanacaste': 762, 'San Jos√©': 756, 'Heredia': 137 },
                cantonFlows: [
                    { from: 'San Jos√©', to: 'Desamparados', count: 45 }, { from: 'Alajuela', to: 'San Carlos', count: 38 }, { from: 'Desamparados', to: 'Aserr√≠', count: 32 }, { from: 'Lim√≥n', to: 'Pococ√≠', count: 25 }, { from: 'Cartago', to: 'Para√≠so', count: 22 }, { from: 'Turrialba', to: 'Chirrip√≥ (Distrito)', count: 20 }, { from: 'Puntarenas', to: 'Osa', count: 18 }, { from: 'Goicoechea', to: 'Moravia', count: 15 }, { from: 'San Ram√≥n', to: 'Pe√±as Blancas (Distrito)', count: 10 }, { from: 'P√©rez Zeled√≥n', to: 'Jim√©nez', count: 10 }
                ],
                purpose: {
                    'Todos': { 'Compra Lote y Construcci√≥n': 4080, 'Construcci√≥n Lote Propio': 1468, 'Mejoras/Ampliaci√≥n': 400, 'Emergencia': 88, 'Otros': 190 },
                    'San Jos√©': { 'Compra Lote y Construcci√≥n': 500, 'Construcci√≥n Lote Propio': 150, 'Mejoras/Ampliaci√≥n': 80, 'Emergencia': 10, 'Otros': 28 },
                    'Alajuela': { 'Compra Lote y Construcci√≥n': 750, 'Construcci√≥n Lote Propio': 250, 'Mejoras/Ampliaci√≥n': 80, 'Emergencia': 11, 'Otros': 30 },
                    'Cartago': { 'Compra Lote y Construcci√≥n': 450, 'Construcci√≥n Lote Propio': 250, 'Mejoras/Ampliaci√≥n': 50, 'Emergencia': 10, 'Otros': 20 },
                    'Heredia': { 'Compra Lote y Construcci√≥n': 90, 'Construcci√≥n Lote Propio': 30, 'Mejoras/Ampliaci√≥n': 10, 'Emergencia': 2, 'Otros': 6 },
                    'Guanacaste': { 'Compra Lote y Construcci√≥n': 500, 'Construcci√≥n Lote Propio': 200, 'Mejoras/Ampliaci√≥n': 40, 'Emergencia': 5, 'Otros': 15 },
                    'Puntarenas': { 'Compra Lote y Construcci√≥n': 900, 'Construcci√≥n Lote Propio': 400, 'Mejoras/Ampliaci√≥n': 80, 'Emergencia': 25, 'Otros': 50 },
                    'Lim√≥n': { 'Compra Lote y Construcci√≥n': 890, 'Construcci√≥n Lote Propio': 188, 'Mejoras/Ampliaci√≥n': 50, 'Emergencia': 25, 'Otros': 51 }
                },
                purposeDetails: {
                    'Compra Lote y Construcci√≥n': { avgBono: 23017370, avgSolucion: 23185632 },
                    'Construcci√≥n Lote Propio': { avgBono: 17509308, avgSolucion: 17509308 },
                    'Mejoras/Ampliaci√≥n': { avgBono: 16801168, avgSolucion: 16963006 },
                    'Emergencia': { avgBono: 22444831, avgSolucion: 22575918 },
                    'Otros': { avgBono: 17700000, avgSolucion: 17800000 }
                },
                programs: { 'EXNEC': 4080, 'IND59': 1468, 'AMPIA': 400, 'EMERG': 88, 'TI59': 75, 'Otros': 115 }
            };

            const renderCharts = () => {
                new Chart(document.getElementById('educationGenderChart'), {
                    type: 'bar',
                    data: data.educationByGender,
                    options: {
                        indexAxis: 'y',
                        ...chartOptions,
                        plugins: {
                            title: { display: false },
                            legend: { position: 'bottom' },
                            tooltip: { callbacks: { label: (c) => `${c.dataset.label || ''}: ${new Intl.NumberFormat('es-CR').format(c.raw)}` } }
                        },
                        scales: {
                            x: { stacked: true, beginAtZero: true },
                            y: { stacked: true, grid: { display: false } }
                        }
                    }
                });

                new Chart(document.getElementById('incomeHistogramChart'), {
                    type: 'bar',
                    data: {
                        labels: data.incomeDistribution.labels,
                        datasets: [{
                            label: 'N√∫mero de Familias',
                            data: data.incomeDistribution.values,
                            backgroundColor: colors.primary
                        }]
                    },
                    options: {
                        ...chartOptions,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                const purposeChartCtx = document.getElementById('purposeChart');
                const purposeChartOptionsWithClick = { ...pieChartOptions, onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const label = purposeChart.data.labels[elements[0].index];
                        const details = data.purposeDetails[label];
                        const detailsContainer = document.getElementById('purposeChartDetails');
                        if (details) {
                            const formatCurrency = (value) => `‚Ç°${new Intl.NumberFormat('es-CR', { maximumFractionDigits: 0 }).format(value)}`;
                            detailsContainer.innerHTML = `<strong class="text-gray-800">${label}</strong><br>Bono Promedio: <span class="font-semibold">${formatCurrency(details.avgBono)}</span><br>Soluci√≥n Promedio: <span class="font-semibold">${formatCurrency(details.avgSolucion)}</span>`;
                            detailsContainer.style.display = 'block';
                        }
                    }
                }};
                
                const purposeChart = new Chart(purposeChartCtx, { type: 'doughnut', data: { labels: Object.keys(data.purpose['Todos']), datasets: [{ data: Object.values(data.purpose['Todos']), backgroundColor: colors.chartPalette, borderColor: '#ffffff', borderWidth: 4 }] }, options: purposeChartOptionsWithClick });
                
                document.getElementById('provinceFilter').addEventListener('change', (e) => {
                    const chartData = data.purpose[e.target.value];
                    purposeChart.data.labels = Object.keys(chartData);
                    purposeChart.data.datasets[0].data = Object.values(chartData);
                    purposeChart.update();
                    document.getElementById('purposeChartDetails').style.display = 'none';
                });

                new Chart(document.getElementById('programChart'), { type: 'bar', data: { labels: Object.keys(data.programs).sort((a,b) => data.programs[b] - data.programs[a]), datasets: [{ label: 'N√∫mero de Casos', data: Object.values(data.programs).sort((a,b) => b-a), backgroundColor: colors.primary }] }, options: {...chartOptions, plugins: { legend: { display: false } } } });
            };
            
            const renderTables = () => {
                const cantonFlowsTableBody = document.getElementById('cantonFlowsTable');
                cantonFlowsTableBody.innerHTML = '';
                data.cantonFlows.forEach(flow => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-2">${flow.from}</td><td class="p-2">${flow.to}</td><td class="p-2 text-center font-medium">${flow.count}</td>`;
                    cantonFlowsTableBody.appendChild(row);
                });
            };

            const setupNavObserver = () => {
                const sections = document.querySelectorAll('section');
                const navLinks = document.querySelectorAll('.nav-link');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            navLinks.forEach(link => {
                                link.classList.toggle('active-nav', link.getAttribute('href') === `#${entry.target.id}`);
                            });
                        }
                    });
                }, { rootMargin: "-50% 0px -50% 0px" });
                sections.forEach(section => observer.observe(section));
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        e.preventDefault();
                        document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
                    });
                });
            };
            
            async function callGemini(prompt) {
                const loader = document.getElementById('assistantLoader');
                const resultContainer = document.getElementById('assistantResult');
                
                loader.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                resultContainer.textContent = '';

                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`Error en la API: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    resultContainer.textContent = text;
                } catch (error) {
                    resultContainer.textContent = 'Error al contactar al asistente de IA. Por favor, intente de nuevo m√°s tarde.';
                    console.error('Error:', error);
                } finally {
                    loader.classList.add('hidden');
                    resultContainer.classList.remove('hidden');
                }
            }

            const getDashboardSummary = () => {
                return `
- Total de casos: 6,226
- Jefatura femenina: 75.5%
- Estabilidad provincial (familias que no cambian de provincia): 98.7%
- Prop√≥sito principal: Compra de Lote y Construcci√≥n (65.5%)
- Provincias con m√°s casos: Puntarenas (1457), Lim√≥n (1213), Alajuela (1126)
- Nivel educativo principal: Primaria o menos (81.5%)
- Programa principal: EXNEC (65.5% de los casos)
`;
            };

            const setupGeminiHandlers = () => {
                document.getElementById('generateAnalysisBtn').addEventListener('click', () => {
                    const prompt = `Actuando como un experto analista de pol√≠ticas de vivienda en Costa Rica, analiza los siguientes datos clave sobre el programa de subsidios y genera un resumen ejecutivo conciso seguido de tres recomendaciones estrat√©gicas detalladas y accionables. El tono debe ser formal y propositivo.
Datos Clave:
${getDashboardSummary()}`;
                    callGemini(prompt);
                });

                document.getElementById('askAssistantBtn').addEventListener('click', () => {
                    const question = document.getElementById('policyQuestion').value;
                    if (!question.trim()) {
                        alert('Por favor, ingrese una pregunta.');
                        return;
                    }
                    const prompt = `Eres un asistente de IA experto en pol√≠ticas p√∫blicas de vivienda en Costa Rica. Basado en los siguientes datos resumidos del programa de subsidios, responde la pregunta del analista de la manera m√°s clara y contextualizada posible.
Datos del Programa:
${getDashboardSummary()}
Pregunta del Analista: "${question}"`;
                    callGemini(prompt);
                });
            };
            
            const renderMap = (geoJsonData) => {
                const map = L.map('map').setView([9.7489, -83.7534], 8);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd', maxZoom: 19
                }).addTo(map);

                function getColor(d) {
                    return d > 1400 ? '#08519c' : d > 1000 ? '#3182bd' : d > 750 ? '#6baed6' : d > 500 ? '#9ecae1' : d > 100 ? '#c6dbef' : '#eff3ff';
                }

                function style(feature) {
                    return {
                        fillColor: getColor(data.provinces[feature.properties.provincia]),
                        weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
                    };
                }

                let geojson;
                const highlightFeature = (e) => {
                    const layer = e.target;
                    layer.setStyle({ weight: 5, color: '#666', dashArray: '', fillOpacity: 0.7 });
                    layer.bringToFront();
                };
                const resetHighlight = (e) => geojson.resetStyle(e.target);
                const zoomToFeature = (e) => map.fitBounds(e.target.getBounds());

                function onEachFeature(feature, layer) {
                    layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: zoomToFeature });
                    const provinceName = feature.properties.provincia;
                    const bonoCount = data.provinces[provinceName] || 0;
                    layer.bindPopup(`<b>${provinceName}</b><br/>Casos: ${bonoCount.toLocaleString('es-CR')}`);
                }

                geojson = L.geoJson(geoJsonData, { style: style, onEachFeature: onEachFeature }).addTo(map);

                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    const grades = [0, 100, 500, 750, 1000, 1400];
                    div.innerHTML += '<h4>Casos por Provincia</h4>';
                    for (let i = 0; i < grades.length; i++) {
                        div.innerHTML += `<i style="background:${getColor(grades[i] + 1)}"></i> ${grades[i]}${(grades[i + 1] ? `&ndash;${grades[i + 1]}<br>` : '+')}`;
                    }
                    return div;
                };
                legend.addTo(map);
            };

            const geoJsonData = {"type":"FeatureCollection","features":[
                {"type":"Feature","properties":{"provincia":"San Jos√©"},"geometry":{"type":"Polygon","coordinates":[[[-84.072,10.02],[-83.74,9.93],[-83.53,9.75],[-83.65,9.22],[-84.07,9.22],[-84.48,9.88],[-84.072,10.02]]]}},
                {"type":"Feature","properties":{"provincia":"Alajuela"},"geometry":{"type":"Polygon","coordinates":[[[-84.072,10.02],[-84.48,9.88],[-84.44,10.33],[-84.89,10.58],[-85.03,10.93],[-84.51,11.22],[-84.07,10.73],[-84.072,10.02]]]}},
                {"type":"Feature","properties":{"provincia":"Heredia"},"geometry":{"type":"Polygon","coordinates":[[[-84.072,10.02],[-84.07,10.73],[-83.8,10.73],[-83.8,10.45],[-84.072,10.02]]]}},
                {"type":"Feature","properties":{"provincia":"Cartago"},"geometry":{"type":"Polygon","coordinates":[[[-84.072,10.02],[-83.8,10.45],[-83.5,10.05],[-83.53,9.75],[-83.74,9.93],[-84.072,10.02]]]}},
                {"type":"Feature","properties":{"provincia":"Guanacaste"},"geometry":{"type":"Polygon","coordinates":[[[-85.03,10.93],[-85.3,11.22],[-85.93,10.9],[-85.67,10.25],[-85.05,9.9],[-84.89,10.58],[-85.03,10.93]]]}},
                {"type":"Feature","properties":{"provincia":"Puntarenas"},"geometry":{"type":"Polygon","coordinates":[[[-85.05,9.9],[-84.48,9.88],[-84.07,9.22],[-83.65,9.22],[-83.2,8.5],[-82.9,8.2],[-83.5,8.9],[-84.7,9.6],[-85.05,9.9]]]}},
                {"type":"Feature","properties":{"provincia":"Lim√≥n"},"geometry":{"type":"Polygon","coordinates":[[[-83.5,10.05],[-83.8,10.45],[-83.8,10.73],[-83.3,10.8],[-82.55,9.6],[-82.9,8.2],[-83.2,8.5],[-83.65,9.22],[-83.53,9.75],[-83.5,10.05]]]}}
            ]};

            renderCharts();
            renderTables();
            setupNavObserver();
            setupGeminiHandlers();
            renderMap(geoJsonData);
        });
    </script>
</body>
</html>
